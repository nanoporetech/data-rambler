<!DOCTYPE html>
<html>
  <head>
    <style>
      html {
        height: 100%;
      }
      body {
        height: 100%;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 3rem 1fr 2fr;
      }
      .header {
        grid-column: 1 / 3;
        grid-row: 1;
        background-color: rgb(0 142 171);
      }
      .json-pane {
        grid-column: 1;
        grid-row: 2 / 4;
        background-color: rgb(255, 255, 245);
        border-right: 2px solid rgb(0 142 171);
        overflow: auto;
        padding: 1rem;
        box-sizing: border-box; 
        outline: none;
        font-family: monospace;
        white-space: pre;
      }
      .expression-pane {
        grid-column: 2;
        grid-row: 2;
        background-color: rgb(255, 255, 245);
        border-bottom: 2px solid rgb(0 142 171);
        overflow: auto;
        padding: 1rem;
        box-sizing: border-box;
        outline: none;
        font-family: monospace;
        white-space: pre;
      }
      .output-pane {
        grid-column: 2;
        grid-row: 3;
        background-color: lightgrey;
        overflow: auto;
        padding: 1rem;
        box-sizing: border-box;
        font-family: monospace;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <select class="dataset-selector">
        <option value="dataset0.json">dataset 0</option>
        <option value="dataset1.json">dataset 1</option>
        <option value="dataset2.json">dataset 2</option>
        <option value="dataset3.json">dataset 3</option>
        <option value="dataset4.json">dataset 4</option>
        <option value="dataset5.json">dataset 5</option>
        <option value="dataset6.json">dataset 6</option>
        <option value="dataset7.json">dataset 7</option>
        <option value="dataset8.json">dataset 8</option>
        <option value="dataset9.json">dataset 9</option>
        <option value="dataset10.json">dataset 10</option>
        <option value="dataset11.json">dataset 11</option>
        <option value="dataset12.json">dataset 12</option>
        <option value="dataset13.json">dataset 13</option>
        <option value="dataset14.json">dataset 14</option>
        <option value="dataset15.json">dataset 15</option>
        <option value="dataset16.json">dataset 16</option>
        <option value="dataset17.json">dataset 17</option>
        <option value="dataset18.json">dataset 18</option>
        <option value="dataset19.json">dataset 19</option>
        <option value="dataset20.json">dataset 20</option>
        <option value="dataset21.json">dataset 21</option>
        <option value="dataset22.json">dataset 22</option>
        <option value="dataset23.json">dataset 23</option>
        <option value="dataset24.json">dataset 24</option>
        <option value="employees.json">employees</option>
        <option value="items.json">items</option>
        <option value="library.json">library</option>
      </select>
    </div>
    <div class="json-pane" contenteditable>
      {
        "Account": {
          "Account Name": "Firefly",
          "Order": [
            {
              "OrderID": "order103",
              "Product": [
                {
                  "Product Name": "Bowler Hat",
                  "ProductID": 858383,
                  "SKU": "0406654608",
                  "Description": {
                    "Colour": "Purple",
                    "Width": 300,
                    "Height": 200,
                    "Depth": 210,
                    "Weight": 0.75
                  },
                  "Price": 34.45,
                  "Quantity": 2
                },
                {
                  "Product Name": "Trilby hat",
                  "ProductID": 858236,
                  "SKU": "0406634348",
                  "Description": {
                    "Colour": "Orange",
                    "Width": 300,
                    "Height": 200,
                    "Depth": 210,
                    "Weight": 0.6
                  },
                  "Price": 21.67,
                  "Quantity": 1
                }
              ]
            },
            {
              "OrderID": "order104",
              "Product": [
                {
                  "Product Name": "Bowler Hat",
                  "ProductID": 858383,
                  "SKU": "040657863",
                  "Description": {
                    "Colour": "Purple",
                    "Width": 300,
                    "Height": 200,
                    "Depth": 210,
                    "Weight": 0.75
                  },
                  "Price": 34.45,
                  "Quantity": 4
                },
                {
                  "ProductID": 345664,
                  "SKU": "0406654603",
                  "Product Name": "Cloak",
                  "Description": {
                    "Colour": "Black",
                    "Width": 30,
                    "Height": 20,
                    "Depth": 210,
                    "Weight": 2
                  },
                  "Price": 107.99,
                  "Quantity": 1
                }
              ]
            }
          ]
        }
      }
    </div>
    <div class="expression-pane" contenteditable>
      Account.Order.Product.(Price * Quantity)
    </div>
    <div class="output-pane"></div>
    <script type="module">
      import { prepare_expression, scan, Runtime } from './mjs/index.mjs';

      document.querySelector('[contenteditable]').addEventListener('paste', function (event) {
        event.preventDefault();
        document.execCommand('inserttext', false, event.clipboardData.getData('text/plain'));
      });

      const json_pane = document.querySelector('.json-pane');
      const expression_pane = document.querySelector('.expression-pane');
      const output_pane = document.querySelector('.output-pane');
      const dataset_selector = document.querySelector('.dataset-selector');

      const runtime = new Runtime;

      function update () {
        const expr_source = expression_pane.textContent;

        let expr;
        try {
          expr = prepare_expression(runtime, expr_source);
          localStorage.setItem('expr', expr_source);
        } catch (e) {
          output_pane.textContent = e.message;
          return;
        }

        let data;
        try {
          data = JSON.parse(json_pane.textContent);
          localStorage.setItem('json', JSON.stringify(data));
        } catch {
          output_pane.textContent = 'Invalid JSON';
          return;
        }

        let result;
        try {
          result = expr(data);
        } catch (e) {
          output_pane.textContent = e.message;
          return;
        }

        if (result === undefined) {
          output_pane.textContent = 'No match';
        } else {
          output_pane.textContent = JSON.stringify(result, null, 2);
        }
      }

      function restore_state () {
        const expr_source = localStorage.getItem('expr');
        const json_data = localStorage.getItem('json');

        if (expr_source) {
          expression_pane.textContent = expr_source;
        }
        if (json_data) {
          json_pane.textContent = JSON.stringify(JSON.parse(json_data), null, 2);
        }

        update();
      }

      json_pane.addEventListener('input', () => {
        update();
      });
      expression_pane.addEventListener('input', () => {
        update();
      });

      dataset_selector.addEventListener('change', async (e) => {
        const res = await fetch(`datasets/${e.target.value}`);
        json_pane.textContent = JSON.stringify(await res.json(), null, 2);
      })

      restore_state();
    </script>
  </body>
</html>